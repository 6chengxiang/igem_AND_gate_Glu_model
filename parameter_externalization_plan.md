# 参数外部化规划

## 1. 目标

将当前脚本中硬编码的参数（特别是模型参数和模拟参数）外部化，使其可以通过配置文件或环境变量进行配置。此举旨在提高代码的灵活性、可维护性和可重用性，并为未来将项目封装为Python包或CLI软件（部署至GitHub，无需追求极致完善）奠定基础。

## 2. 现有问题

- **参数分散**: 参数散布在各个脚本和模型文件中，难以集中管理。
- **修改不便**: 每次修改参数都需要直接编辑源代码，容易引入错误且效率低下。
- **可重用性差**: 不同实验或场景需要不同的参数配置时，需要复制和修改代码。
- **不利于自动化**: 难以进行参数扫描、优化或自动化测试。

## 3. 必须自定义的参数

根据项目未来封装为Python包或CLI软件的需求，以下参数被识别为必须外部化和自定义的参数：

### 3.1. `scripts/assess_neurotoxicity.py` 中的参数

*   **`sim_hours`**: 模拟总时长 (单位：小时)
*   **`dt_h`**: 模拟时间步长 (单位：小时)
*   **`baseline_uM`**: 血浆/组织/脑脊液的基线谷氨酸浓度 (单位：μM)
*   **`intensity`**: 通量强度，可选值如 "mild" 或 "high"，影响峰值通量
*   **`t_on`**: 通量开始时间 (单位：小时)
*   **`ramp_hours`**: 通量上升和下降的持续时间 (单位：小时)
*   **`t_off`**: 通量结束时间 (单位：小时)

### 3.2. `models/and_gate.py` 中的参数

*   **启动子参数 (来自 `params/promoters.json`)**:
    *   `pPept`:
        *   `beta`: 最大表达量
        *   `K`: 半数效应浓度/温度
        *   `n`: Hill系数
        *   `leaky`: 基础泄露表达
        *   `type`: 激活型 (`act`) 或抑制型 (`rep`)
    *   `pLR`:
        *   `beta`: 最大表达量
        *   `K`: 半数效应浓度/温度
        *   `n`: Hill系数
        *   `leaky`: 基础泄露表达
        *   `type`: 激活型 (`act`) 或抑制型 (`rep`)
*   **分裂 T7 组装参数 (来自 `params/splitT7.json`)**:
    *   `alpha`: 组装效率
    *   `Kd`: 解离常数
    *   `leaky`: 基础泄露活性
*   **详细 AND 门模型参数 (在 `BaseDetailedANDGate` 类中定义)**:
    *   `k_assembly`: T7 组装速率常数
    *   `k_disassembly`: T7 解离速率常数
    *   `k_deg`: T7 降解速率常数

### 3.3. `models/diffusion_pk.py` 中的参数

*   **多室药代动力学 (MultiCompartmentPK) 模型参数**:
    *   `V_blood`: 血液室体积 (L)
    *   `V_liver`: 肝脏室体积 (L)
    *   `V_tumor`: 肿瘤室体积 (L)
    *   `V_other`: 其他组织室体积 (L)
    *   `q_blood_liver`: 血液到肝脏的流速 (L/hr)
    *   `q_blood_tumor`: 血液到肿瘤的流速 (L/hr)
    *   `q_blood_other`: 血液到其他组织的流速 (L/hr)
    *   `k_elim_liver`: 肝脏清除率 (1/hr)
    *   `k_uptake_tumor`: 肿瘤摄取率 (1/hr)
*   **肿瘤扩散 (TumorDiffusion) 模型参数**:
    *   `D`: 扩散系数 (cm²/hr)
    *   `k_uptake`: 肿瘤细胞摄取率 (1/hr)
    *   `L`: 肿瘤直径 (cm)
    *   `Nx`: 空间网格点数

### 3.4. `models/glu_metabolism.py` 中的参数

*   **谷氨酸代谢模型 (GluMetabolismModel) 参数**:
    *   `k_prod_max`: 最大谷氨酸生产速率 (mM/hr)
    *   `K_t7`: T7活性达到半最大生产速率时的值 (AU)
    *   `k_export_max`: 最大谷氨酸分泌速率 (mM/hr)
    *   `K_export`: 细胞内谷氨酸浓度达到半最大分泌速率时的值 (mM)
    *   `k_dilution`: 细胞生长或降解导致的稀释/降解速率 (1/hr)
    *   `V_intra_over_V_extra`: 细胞内总体积与细胞外总体积的比率
    *   `k_syn_icd`: Icd合成速率 (1/hr)
    *   `k_syn_gdhA`: gdhA合成速率 (1/hr)
    *   `k_deg_icd`: Icd降解速率 (1/hr)
    *   `k_deg_gdhA`: gdhA降解速率 (1/hr)
    *   `Vmax_icd`: Icd最大催化速率 (mM/hr)
    *   `K_icd`: Icd底物常数 (mM)
    *   `Vmax_gdhA`: gdhA最大催化速率 (mM/hr)
    *   `K_gdhA`: gdhA底物常数 (mM)
    *   `n_hill`: Hill系数，用于增强开关效应

### 3.5. `models/integrated_model.py` 中的参数

*   **整合治疗模型 (IntegratedTherapyModel) 参数**:
    *   `glu_params`: 谷氨酸代谢模型的参数，此处设置了默认值，包括 `K_t7`, `k_syn_icd`, `k_syn_gdhA`, `k_deg_icd`, `k_deg_gdhA`, `k_dilution`, `Vmax_gdhA`, `n_hill`。
    *   `r`: 肿瘤生长速率
    *   `K_tumor`: 肿瘤承载能力 (细胞数)
    *   `k_ferroptosis_max`: 最大铁死亡速率
    *   `K_glu`: 谷氨酸铁死亡阈值
    *   `n_glu`: 谷氨酸铁死亡的Hill系数
    *   `r_eng`: 工程细胞生长速率
    *   `K_eng`: 工程细胞承载能力
    *   `V_cell`: 单个细胞体积 (L/cell)
    *   `V_tumor_ext`: 肿瘤间质液体积 (L)

### 3.6. `models/pk_toxicity.py` 中的参数

*   **药代动力学参数 (PKParams)**:
    *   `Vb`: 血浆体积 (L)
    *   `Vt`: 肿瘤体积 (L)
    *   `Vn`: 正常组织等效体积 (L)
    *   `k_bt`: 血<->肿瘤交换速率 (h^-1)
    *   `k_bn`: 血<->正常组织交换速率 (h^-1)
    *   `k_b_clr`: 血浆清除速率 (h^-1)
    *   `k_t_clr`: 肿瘤清除速率 (h^-1)
    *   `k_n_clr`: 正常组织清除速率 (h^-1)

*   **毒性阈值 (ToxicityThresholds)**:
    *   `caution_um`: 提示阈值 (μM)
    *   `danger_um`: 危险阈值 (μM)

## 4. 解决方案概述

引入一个统一的参数管理机制，通过以下步骤实现参数外部化：

1.  **定义参数结构**: 明确需要外部化的参数及其默认值、类型和描述。
2.  **选择配置格式**: 考虑使用JSON、YAML或Python模块作为参数配置文件。
3.  **实现参数加载**: 编写一个通用的参数加载模块，负责从配置文件或环境变量中读取参数。
4.  **修改现有脚本**: 更新现有脚本和模型，使其从参数加载模块中获取参数，而不是使用硬编码值。
5.  **提供命令行接口**: 允许通过命令行参数覆盖配置文件中的参数，提高灵活性。

## 5. 详细规划

### 4.1 阶段一：参数识别与分类

- **任务**: 遍历所有相关脚本和模型文件（`main.py`, `generate_final_analysis.py`, `run_analysis.py`, `assess_neurotoxicity.py`, `models/*.py`），识别所有硬编码的参数。
- **输出**: 一个详细的参数列表，包括参数名、当前值、所属模块、数据类型和简要描述。

### 4.2 阶段二：选择配置格式与工具

- **任务**: 评估不同的配置格式（JSON, YAML, Python模块）及其对应的库（如 `json`, `PyYAML`, `argparse`）。
- **考虑因素**: 易读性、易用性、对复杂数据结构的支持、与现有Python生态的集成度。
- **初步建议**: 考虑到Python项目的常见实践和易用性，建议使用JSON文件作为主要的参数配置文件，并结合`argparse`库处理命令行参数。
- **输出**: 确定配置格式和主要使用的Python库。

### 4.3 阶段三：创建参数管理模块

- **任务**: 创建一个新的Python模块（例如 `config_manager.py` 或 `params_loader.py`），负责参数的加载、验证和访问。
- **功能**:
    - **加载默认参数**: 定义所有参数的默认值。
    - **加载配置文件**: 从指定的JSON文件中加载参数，并覆盖默认值。
    - **加载环境变量/命令行参数**: 支持从环境变量或命令行参数中读取参数，并覆盖配置文件中的值。
    - **参数验证**: 对加载的参数进行类型和范围检查，确保其有效性。
    - **参数访问**: 提供统一的接口供其他模块访问参数。
- **输出**: `config_manager.py` 文件及其相关测试。

### 4.4 阶段四：修改现有脚本和模型

- **任务**: 逐步修改 `main.py`、`generate_final_analysis.py`、`run_analysis.py`、`assess_neurotoxicity.py` 以及 `models` 文件夹下的所有模型文件，使其从 `config_manager.py` 中获取参数。
- **修改策略**:
    - **逐步替换**: 每次修改一个文件或一个模块的参数，并进行测试。
    - **参数传递**: 确保参数能够正确地从顶层脚本传递到所需的子模块和函数。
    - **移除硬编码**: 彻底移除源代码中的硬编码参数。
- **输出**: 更新后的所有脚本和模型文件。

### 4.5 阶段五：测试与验证

- **任务**: 对修改后的整个系统进行全面的测试，确保所有功能正常，并且参数外部化机制按预期工作。
- **测试内容**:
    - **功能测试**: 验证所有模拟和分析结果与修改前一致（在默认参数下）。
    - **参数覆盖测试**: 测试通过配置文件和命令行参数覆盖默认值的功能。
    - **错误处理测试**: 测试无效参数输入时的错误处理机制。
- **输出**: 测试报告和任何必要的修复。

## 5. 风险与挑战

- **参数依赖性**: 某些参数可能存在复杂的相互依赖关系，需要仔细处理。
- **兼容性**: 确保参数外部化不会破坏现有代码的逻辑和功能。
- **性能影响**: 参数加载机制应尽可能高效，避免引入显著的性能开销。

## 6. 后续展望

- **参数优化**: 基于外部化参数，可以更容易地进行参数敏感性分析和优化。
- **Web界面/GUI**: 为参数配置提供图形用户界面，进一步简化操作。
- **模型封装**: 为模型提供更清晰的接口，便于集成到其他系统或作为服务部署。

## 7. 实施时间预估

- **阶段一**: 1-2小时
- **阶段二**: 0.5小时
- **阶段三**: 2-4小时
- **阶段四**: 4-8小时 (取决于参数数量和复杂性)
- **阶段五**: 2-4小时

**总计**: 9.5 - 18.5 小时

请您审阅此规划，如有任何修改意见，请随时提出。